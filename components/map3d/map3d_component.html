
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D航线地图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
        }
        
        #map3d-container {
            width: 100%;
            height: 600px;
            position: relative;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #666;
            font-size: 14px;
            text-align: center;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #e74c3c;
        }
        
        .success-message {
            color: #27ae60;
            text-align: center;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
            margin: 10px;
            border: 1px solid #27ae60;
        }
        
        #map3d {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .status-bar {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            z-index: 100;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            z-index: 100;
            display: none;
        }
        
        .control-item {
            margin-bottom: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map3d-container">
        <!-- 加载状态 -->
        <div id="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在加载3D地图...</div>
            <div style="margin-top: 10px; color: #666;">正在加载3D地图...</div>
        </div>
        
        <!-- 状态栏 -->
        <div class="status-bar" id="status-bar">
            <div>状态: <span id="status-text">初始化中...</span></div>
            <div>API状态: <span id="api-status">检查中...</span></div>
            <div>渲染模式: <span id="render-mode">3D</span></div>
        </div>
        
        <!-- 3D地图将在这里渲染 -->
        <gmp-map-3d id="map3d"
            center="39.9042,116.4074"
            zoom="5"
            map-id="{{MAP_ID}}"
            mode="HYBRID"
            tilt="45"
            heading="0">
        </gmp-map-3d>
        
        <!-- 控制面板 -->
        <div class="controls" id="controls">
            <div class="control-item">缩放: <span id="zoom-level">5</span></div>
            <div class="control-item">倾斜: <span id="tilt-angle">45°</span></div>
        </div>
    </div>
    
    <script>
        // 配置数据
        const CONFIG = {{CONFIG}};
        const ROUTE_DATA = {{ROUTE_DATA}};
        
        // 全局变量
        let map3d = null;
        let isMapLoaded = false;
        let loadStartTime = Date.now();
        
        // 状态更新函数
        function updateStatus(text) {
            const statusElement = document.getElementById('status-text');
            if (statusElement) {
                statusElement.textContent = text;
            }
            console.log('状态更新:', text);
        }
        
        function updateApiStatus(text) {
            const apiStatusElement = document.getElementById('api-status');
            if (apiStatusElement) {
                apiStatusElement.textContent = text;
            }
        }
        
        // 初始化3D地图
        async function initMap3D() {
            console.log('开始初始化3D地图...');
            updateStatus('正在初始化...');
            
            try {
                // 检查API密钥
                if (!CONFIG.apiKey || CONFIG.apiKey === 'YOUR_API_KEY') {
                    throw new Error('API密钥未配置');
                }
                updateApiStatus('API密钥已配置');
                
                // 动态加载Google Maps API
                if (typeof google === 'undefined' || !google.maps) {
                    updateStatus('加载Google Maps API...');
                    await loadGoogleMapsAPI();
                }
                updateApiStatus('API已加载');
                
                // 获取地图元素
                map3d = document.getElementById('map3d');
                if (!map3d) {
                    throw new Error('无法找到3D地图容器');
                }
                
                // 设置事件监听
                map3d.addEventListener('gmp-load', onMapLoaded);
                map3d.addEventListener('gmp-error', onMapError);
                
                // 显示地图
                map3d.style.display = 'block';
                updateStatus('等待地图加载...');
                
                console.log('3D地图初始化完成');
                
            } catch (error) {
                console.error('3D地图初始化失败:', error);
                showError('3D地图初始化失败: ' + error.message);
            }
        }
        
        // 动态加载Google Maps API
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.maps) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.apiKey}&libraries=maps3d&v=beta`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps API加载完成');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Google Maps API加载失败');
                    reject(new Error('Google Maps API加载失败，请检查网络连接'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // 地图加载完成事件
        function onMapLoaded() {
            const loadTime = Date.now() - loadStartTime;
            console.log('3D地图加载完成');
            
            // 隐藏加载状态
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            // 显示控制面板
            const controls = document.getElementById('controls');
            if (controls) {
                controls.style.display = 'block';
            }
            
            updateStatus('地图加载成功');
            updateApiStatus(`加载完成 (${loadTime}ms)`);
            isMapLoaded = true;
            
            // 发送成功事件到Streamlit
            window.parent.postMessage({
                type: 'map3d-ready',
                data: { loadTime, routeCount: ROUTE_DATA.length }
            }, '*');
            
            // 加载航线数据
            loadRoutes();
        }
        
        // 地图加载错误事件
        function onMapError(event) {
            console.error('3D地图加载错误:', event);
            showError('3D地图加载失败，请检查API密钥和网络连接');
            updateStatus('加载失败');
            updateApiStatus('错误');
        }
        
        // 显示错误信息
        function showError(message) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div class="error-message">
                        <h3>❌ 加载失败</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()">重新加载</button>
                    </div>
                `;
            }
        }
        
        // 加载航线数据
        function loadRoutes() {
            if (!isMapLoaded || !map3d) return;
            
            console.log('开始加载航线数据:', ROUTE_DATA.length, '条');
            updateStatus(`已加载 ${ROUTE_DATA.length} 条航线`);
            
            // 设置地图视角
            if (ROUTE_DATA.length > 0) {
                map3d.flyCameraTo({
                    endCamera: {
                        center: CONFIG.center || { lat: 39.9042, lng: 116.4074 },
                        zoom: CONFIG.zoom || 5,
                        tilt: CONFIG.tilt || 45,
                        heading: CONFIG.heading || 0
                    },
                    durationMillis: 2000
                });
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化3D地图');
            setTimeout(initMap3D, 500); // 延迟500ms确保DOM完全准备好
        });
        
        // 错误处理
        window.addEventListener('error', (event) => {
            console.error('页面错误:', event.error);
            updateStatus('发生错误');
        });
        
        // 调试信息
        console.log('3D地图组件已加载');
        console.log('配置信息:', CONFIG);
        console.log('航线数据:', ROUTE_DATA.length, '条');
    </script>
</body>
</html>
