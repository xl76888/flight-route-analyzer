
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜åŒ–çš„3Dèˆªçº¿åœ°å›¾</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            height: 700px !important;
            min-height: 700px !important;
            max-height: 700px;
            overflow: hidden;
        }
        
        #map3d-container {
            width: 100%;
            height: 700px;
            min-height: 700px;
            position: relative;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e3e3e3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            z-index: 100;
            display: none;
        }
        
        .update-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            display: none;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        #map3d {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .error-message {
            text-align: center;
            color: #e74c3c;
            padding: 20px;
        }
        
        .success-message {
            text-align: center;
            color: #27ae60;
            padding: 20px;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 12px;
            z-index: 200;
            min-width: 180px;
        }
        
        .control-panel h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 13px;
        }
        
        .control-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .control-item label {
            color: #666;
            margin-right: 8px;
        }
        
        .control-item input[type="checkbox"] {
            margin: 0;
        }
        
        .control-item input[type="range"] {
            width: 80px;
            margin: 0;
        }
        
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 11px;
            z-index: 200;
        }
        
        .legend h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            border: 1px solid #ccc;
        }
        
        .legend-line {
            width: 20px;
            height: 2px;
            margin-right: 6px;
            border-radius: 1px;
        }
    </style>
</head>
<body>
    <div id="map3d-container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">æ­£åœ¨åŠ è½½3Dåœ°å›¾...</div>
            <div id="loading-status" style="color: #999; font-size: 12px;">åˆå§‹åŒ–ä¸­...</div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="status-bar">
            <div>èˆªçº¿: <span id="route-count">0</span> æ¡</div>
        </div>
        
        <!-- æ›´æ–°æŒ‡ç¤ºå™¨ -->
        <div class="update-indicator" id="update-indicator">
            æ•°æ®å·²æ›´æ–°
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel" id="control-panel">
            <h4>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h4>
            <div class="control-item">
                <label>åŠ¨ç”»æ•ˆæœ</label>
                <input type="checkbox" id="animation-toggle" checked onchange="toggleAnimation()">
            </div>
            <div class="control-item">
                <label>åŠ¨ç”»é€Ÿåº¦</label>
                <input type="range" id="animation-speed" min="500" max="5000" value="2000" onchange="updateAnimationSpeed()">
            </div>
            <div class="control-item">
                <label>æ˜¾ç¤ºæœºåœº</label>
                <input type="checkbox" id="airport-toggle" checked onchange="toggleAirports()">
            </div>
        </div>
        
        <!-- å›¾ä¾‹ -->
        <div class="legend" id="legend">
            <h4>ğŸ“ å›¾ä¾‹è¯´æ˜</h4>
            <div class="legend-item">
                <div class="legend-line" style="background-color: #4CAF50;"></div>
                <span>è¿›å£èˆªçº¿</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background-color: #FF5722;"></div>
                <span>å‡ºå£èˆªçº¿</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4CAF50;"></div>
                <span>è¿›å£æœºåœº</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF5722;"></div>
                <span>å‡ºå£æœºåœº</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9C27B0;"></div>
                <span>è¿›å‡ºå£æœºåœº</span>
            </div>
        </div>
        
        <!-- 3Dåœ°å›¾ -->
        <gmp-map-3d id="map3d"
            center="39.9042,116.4074"
            zoom="5"
            map-id="{{MAP_ID}}"
            mode="HYBRID"
            tilt="45"
            heading="0">
        </gmp-map-3d>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let map3d = null;
        let isMapInitialized = false;
        let currentRoutes = [];
        let routeElements = new Map();
        let airportMarkers = new Map(); // æœºåœºæ ‡è®°ç¼“å­˜
        let animationEnabled = true; // åŠ¨ç”»å¼€å…³
        let animationSpeed = 2000; // åŠ¨ç”»é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰
        let loadStartTime = Date.now();
        
        // é…ç½®
        const CONFIG = {{CONFIG}};
        let ROUTE_DATA = {{ROUTE_DATA}};
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateLoadingStatus(text) {
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                statusElement.textContent = text;
            }
            console.log('åŠ è½½çŠ¶æ€:', text);
        }
        
        function showUpdateIndicator() {
            const indicator = document.getElementById('update-indicator');
            if (indicator) {
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        function updateRouteCount(count) {
            const countElement = document.getElementById('route-count');
            if (countElement) {
                countElement.textContent = count;
            }
        }
        
        // åˆå§‹åŒ–3Dåœ°å›¾
        async function initMap3D() {
            console.log('å¼€å§‹åˆå§‹åŒ–3Dåœ°å›¾...');
            updateLoadingStatus('æ£€æŸ¥APIé…ç½®...');
            
            try {
                // æ£€æŸ¥APIå¯†é’¥
                if (!CONFIG.apiKey || CONFIG.apiKey === 'YOUR_API_KEY') {
                    throw new Error('APIå¯†é’¥æœªé…ç½®');
                }
                
                // åŠ¨æ€åŠ è½½Google Maps API
                if (typeof google === 'undefined' || !google.maps) {
                    updateLoadingStatus('åŠ è½½Google Maps API...');
                    await loadGoogleMapsAPI();
                }
                
                // è·å–åœ°å›¾å…ƒç´ 
                map3d = document.getElementById('map3d');
                if (!map3d) {
                    throw new Error('æ— æ³•æ‰¾åˆ°3Dåœ°å›¾å®¹å™¨');
                }
                
                // æ£€æŸ¥åœ°å›¾æ˜¯å¦å·²ç»åŠ è½½
                if (map3d.isConnected && map3d.map) {
                    console.log('åœ°å›¾å·²ç»åŠ è½½ï¼Œç›´æ¥è°ƒç”¨onMapLoaded');
                    onMapLoaded();
                } else {
                    // è®¾ç½®äº‹ä»¶ç›‘å¬
                    map3d.addEventListener('gmp-load', onMapLoaded);
                    map3d.addEventListener('gmp-error', onMapError);
                    
                    // æ˜¾ç¤ºåœ°å›¾
                    map3d.style.display = 'block';
                    updateLoadingStatus('ç­‰å¾…åœ°å›¾åŠ è½½...');
                    
                    // è®¾ç½®è¶…æ—¶æ£€æŸ¥ï¼Œå¦‚æœ5ç§’åè¿˜æ²¡åŠ è½½å®Œæˆï¼Œå¼ºåˆ¶è°ƒç”¨onMapLoaded
                    setTimeout(() => {
                        if (!isMapInitialized) {
                            console.log('åœ°å›¾åŠ è½½è¶…æ—¶ï¼Œå¼ºåˆ¶å®Œæˆåˆå§‹åŒ–');
                            onMapLoaded();
                        }
                    }, 5000);
                }
                
                console.log('3Dåœ°å›¾åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('3Dåœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                showError('3Dåœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ¨æ€åŠ è½½Google Maps API
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.maps) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.apiKey}&libraries=maps3d,marker&v=beta`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps APIåŠ è½½å®Œæˆ');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Google Maps APIåŠ è½½å¤±è´¥');
                    reject(new Error('Google Maps APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
        async function onMapLoaded() {
            const loadTime = Date.now() - loadStartTime;
            console.log('3Dåœ°å›¾åŠ è½½å®Œæˆï¼Œè€—æ—¶:', loadTime + 'ms');
            
            // å¯¼å…¥å¿…è¦çš„åº“
            try {
                const { Map3DElement, Marker3DElement, Marker3DInteractiveElement, PopoverElement } = await google.maps.importLibrary('maps3d');
                const { PinElement } = await google.maps.importLibrary('marker');
                window.PinElement = PinElement;
                window.Marker3DElement = Marker3DElement;
                window.Marker3DInteractiveElement = Marker3DInteractiveElement;
                window.PopoverElement = PopoverElement;
                console.log('Google Maps 3D å’Œ Marker åº“å¯¼å…¥æˆåŠŸï¼ŒåŒ…å«äº¤äº’å¼æ ‡è®°å’Œå¼¹å‡ºæ¡†');
            } catch (error) {
                console.error('å¯¼å…¥ Google Maps åº“å¤±è´¥:', error);
            }
            
            // éšè—åŠ è½½çŠ¶æ€
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            // æ˜¾ç¤ºçŠ¶æ€æ 
            const statusBar = document.getElementById('status-bar');
            if (statusBar) {
                statusBar.style.display = 'block';
            }
            
            isMapInitialized = true;
            
            // å‘é€æˆåŠŸäº‹ä»¶åˆ°Streamlit
            window.parent.postMessage({
                type: 'map3d-ready',
                data: { loadTime, routeCount: ROUTE_DATA.length }
            }, '*');
            
            // å»¶è¿ŸåŠ è½½åˆå§‹èˆªçº¿æ•°æ®ï¼Œç¡®ä¿åœ°å›¾å®Œå…¨å‡†å¤‡å¥½
            setTimeout(() => {
                console.log('å¼€å§‹åŠ è½½èˆªçº¿æ•°æ®ï¼Œæ•°æ®é‡:', ROUTE_DATA.length);
                if (ROUTE_DATA && ROUTE_DATA.length > 0) {
                    updateRoutes(ROUTE_DATA);
                } else {
                    console.warn('æ²¡æœ‰èˆªçº¿æ•°æ®å¯åŠ è½½');
                }
            }, 1500); // å¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿åœ°å›¾å®Œå…¨å‡†å¤‡å¥½
        }
        
        // åœ°å›¾åŠ è½½é”™è¯¯äº‹ä»¶
        function onMapError(event) {
            console.error('3Dåœ°å›¾åŠ è½½é”™è¯¯:', event);
            showError('3Dåœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥å’Œç½‘ç»œè¿æ¥');
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div class="error-message">
                        <h3>âŒ åŠ è½½å¤±è´¥</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°èˆªçº¿æ•°æ®ï¼ˆæ ¸å¿ƒä¼˜åŒ–åŠŸèƒ½ï¼‰
        function updateRoutes(newRouteData) {
            if (!isMapInitialized || !map3d) {
                console.log('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œç¼“å­˜æ•°æ®ç­‰å¾…åŠ è½½');
                ROUTE_DATA = newRouteData;
                return;
            }
            
            console.log('æ›´æ–°èˆªçº¿æ•°æ®:', newRouteData.length, 'æ¡');
            
            // æ¸…é™¤ç°æœ‰èˆªçº¿å’Œæœºåœºæ ‡è®°
            clearRoutes();
            clearAirportMarkers();
            
            // æ·»åŠ æ–°èˆªçº¿å’Œæœºåœºæ ‡è®°
            if (newRouteData && newRouteData.length > 0) {
                addRoutes(newRouteData);
                addAirportMarkers(newRouteData);
                
                // è°ƒæ•´è§†è§’ä»¥é€‚åº”æ–°æ•°æ®
                fitBounds(newRouteData);
            }
            
            // æ›´æ–°çŠ¶æ€
            updateRouteCount(newRouteData.length);
            showUpdateIndicator();
            
            // ç¼“å­˜å½“å‰æ•°æ®
            currentRoutes = newRouteData;
        }
        
        // æ¸…é™¤æ‰€æœ‰èˆªçº¿
        function clearRoutes() {
            routeElements.forEach(element => {
                if (element && element.remove) {
                    element.remove();
                }
            });
            routeElements.clear();
        }
        
        // æ¸…é™¤æ‰€æœ‰æœºåœºæ ‡è®° - ä¼˜åŒ–ç‰ˆæœ¬
        function clearAirportMarkers() {
            airportMarkers.forEach(marker => {
                try {
                    if (marker) {
                        if (marker.parentNode) {
                            marker.parentNode.removeChild(marker);
                        } else if (marker.remove) {
                            marker.remove();
                        }
                    }
                } catch (error) {
                    console.warn('æ¸…é™¤æœºåœºæ ‡è®°æ—¶å‡ºé”™:', error.message);
                }
            });
            airportMarkers.clear();
            console.log('æœºåœºæ ‡è®°å·²æ¸…é™¤');
        }
        
        // æ·»åŠ æœºåœºæ ‡è®° - ä¼˜åŒ–ç‰ˆæœ¬
        function addAirportMarkers(routes) {
            if (!window.google || !window.google.maps || !window.google.maps.maps3d) {
                console.warn('Google Maps 3D APIæœªåŠ è½½ï¼Œè·³è¿‡æœºåœºæ ‡è®°åˆ›å»º');
                return;
            }
            
            if (!routes || routes.length === 0) {
                console.log('æ²¡æœ‰èˆªçº¿æ•°æ®ï¼Œè·³è¿‡æœºåœºæ ‡è®°åˆ›å»º');
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„æœºåœº
            const airports = new Map();
            
            routes.forEach(route => {
                if (isValidRoute(route)) {
                    try {
                        // èµ·å§‹æœºåœº
                        const startKey = `${route.start_lat}_${route.start_lng}`;
                        if (!airports.has(startKey)) {
                            airports.set(startKey, {
                                lat: parseFloat(route.start_lat),
                                lng: parseFloat(route.start_lng),
                                name: route.start_airport_name || route.start_airport || route.origin || 'æœªçŸ¥æœºåœº',
                                code: route.start_airport || route.origin || '',
                                type: 'origin',
                                routes: [],
                                isOrigin: true,
                                isDestination: false,
                                isTransit: false
                            });
                        }
                        const startAirport = airports.get(startKey);
                        startAirport.routes.push(route);
                        startAirport.isOrigin = true;
                        
                        // ç›®çš„æœºåœº
                        const endKey = `${route.end_lat}_${route.end_lng}`;
                        if (!airports.has(endKey)) {
                            airports.set(endKey, {
                                lat: parseFloat(route.end_lat),
                                lng: parseFloat(route.end_lng),
                                name: route.end_airport_name || route.end_airport || route.destination || 'æœªçŸ¥æœºåœº',
                                code: route.end_airport || route.destination || '',
                                type: 'destination',
                                routes: [],
                                isOrigin: false,
                                isDestination: true,
                                isTransit: false
                            });
                        }
                        const endAirport = airports.get(endKey);
                        endAirport.routes.push(route);
                        endAirport.isDestination = true;
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­è½¬æœºåœºï¼ˆæ—¢æ˜¯èµ·ç‚¹åˆæ˜¯ç»ˆç‚¹ï¼‰
                        if (startAirport.isDestination) {
                            startAirport.isTransit = true;
                        }
                        if (endAirport.isOrigin) {
                            endAirport.isTransit = true;
                        }
                    } catch (error) {
                        console.warn('å¤„ç†èˆªçº¿æœºåœºæ•°æ®æ—¶å‡ºé”™:', error, route);
                    }
                }
            });
            
            // é™åˆ¶æœºåœºæ ‡è®°æ•°é‡ï¼Œé¿å…æ€§èƒ½é—®é¢˜
            const maxMarkers = 50;
            let markerCount = 0;
            let processedCount = 0;
            
            // å¼‚æ­¥åˆ›å»ºæœºåœºæ ‡è®°
            const createMarkersPromises = [];
            airports.forEach((airport, key) => {
                if (processedCount >= maxMarkers) {
                    return; // è·³è¿‡å‰©ä½™çš„æœºåœº
                }
                
                const promise = createAirportMarker(airport, key)
                    .then(marker => {
                        if (marker) {
                            airportMarkers.set(key, marker);
                            markerCount++;
                            return marker;
                        }
                        return null;
                    })
                    .catch(error => {
                        console.warn('åˆ›å»ºæœºåœºæ ‡è®°å¤±è´¥:', error.message);
                        return null;
                    });
                
                createMarkersPromises.push(promise);
                processedCount++;
            });
            
            // ç­‰å¾…æ‰€æœ‰æ ‡è®°åˆ›å»ºå®Œæˆ
            Promise.all(createMarkersPromises).then(() => {
                console.log(`æœºåœºæ ‡è®°åˆ›å»ºå®Œæˆ: ${markerCount} ä¸ª (æ€»æœºåœºæ•°: ${airports.size})`);
                
                if (airports.size > maxMarkers) {
                    console.log(`ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œåªæ˜¾ç¤ºå‰ ${maxMarkers} ä¸ªæœºåœºæ ‡è®°`);
                }
            });
            
            console.log(`æœºåœºæ ‡è®°åˆ›å»ºå®Œæˆ: ${markerCount} ä¸ª (æ€»æœºåœºæ•°: ${airports.size})`);
            
            if (airports.size > maxMarkers) {
                console.log(`ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œåªæ˜¾ç¤ºå‰ ${maxMarkers} ä¸ªæœºåœºæ ‡è®°`);
            }
        }
        
        // åˆ›å»ºæœºåœºæ ‡è®° - ä½¿ç”¨Google Mapsæ”¯æŒçš„PinElement
        async function createAirportMarker(airport, key) {
            try {
                // æ£€æŸ¥Google Maps 3D APIæ˜¯å¦å¯ç”¨
                if (!window.google || !window.google.maps || !window.google.maps.maps3d) {
                    console.error('Google Maps 3D APIæœªåŠ è½½ï¼Œæ— æ³•åˆ›å»ºæœºåœºæ ‡è®°');
                    return null;
                }
                
                // ç¡®ä¿ PinElement å’Œ Marker3DInteractiveElement å·²åŠ è½½
                if (!window.PinElement || !window.Marker3DInteractiveElement) {
                    console.warn('PinElement æˆ– Marker3DInteractiveElement æœªåŠ è½½ï¼Œè·³è¿‡æœºåœºæ ‡è®°åˆ›å»º');
                    return null;
                }
                
                // è®¾ç½®æ ‡è®°æ ·å¼
                const hasImport = airport.routes.some(r => r.direction === 'è¿›å£');
                const hasExport = airport.routes.some(r => r.direction === 'å‡ºå£');
                
                // æ ¹æ®æœºåœºè§’è‰²è®¾ç½®é¢œè‰²å’Œå›¾æ ‡
                let color = '#2196F3'; // é»˜è®¤è“è‰²
                let glyphText = 'âœˆ';
                let roleText = '';
                
                if (airport.isTransit) {
                    color = '#FF9800'; // æ©™è‰² - ä¸­è½¬æœºåœº
                    glyphText = 'ğŸ”„';
                    roleText = 'ä¸­è½¬';
                } else if (airport.isOrigin && airport.isDestination) {
                    color = '#9C27B0'; // ç´«è‰² - æ—¢æœ‰è¿›å£åˆæœ‰å‡ºå£
                    glyphText = 'â‡„';
                    roleText = 'åŒå‘';
                } else if (airport.isOrigin) {
                    color = '#4CAF50'; // ç»¿è‰² - å§‹å‘åœ°
                    glyphText = 'ğŸ›«';
                    roleText = 'å§‹å‘';
                } else if (airport.isDestination) {
                    color = '#F44336'; // çº¢è‰² - ç›®çš„åœ°
                    glyphText = 'ğŸ›¬';
                    roleText = 'ç›®çš„';
                }
                
                // å¦‚æœæœ‰è¿›å‡ºå£ä¿¡æ¯ï¼Œä¼˜å…ˆæ˜¾ç¤º
                if (hasImport && hasExport) {
                    color = '#9C27B0'; // ç´«è‰² - æ—¢æœ‰è¿›å£åˆæœ‰å‡ºå£
                    roleText = 'è¿›å‡ºå£';
                } else if (hasImport) {
                    color = '#4CAF50'; // ç»¿è‰² - ä»…è¿›å£
                    roleText = 'è¿›å£';
                } else if (hasExport) {
                    color = '#FF5722'; // æ©™çº¢è‰² - ä»…å‡ºå£
                    roleText = 'å‡ºå£';
                }
                
                // 3Dæ ‡è®°ä¸ä½¿ç”¨PinElementï¼Œè€Œæ˜¯ä½¿ç”¨å†…ç½®çš„labelå±æ€§
                
                // åˆ›å»º PopoverElement ç”¨äºæ‚¬åœæç¤º
                const popover = new window.google.maps.maps3d.PopoverElement();
                
                // è®¾ç½®æ‚¬åœæç¤ºå†…å®¹
                const popoverContent = document.createElement('div');
                popoverContent.style.cssText = `
                    padding: 8px 12px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    border-radius: 4px;
                    font-size: 12px;
                    font-family: Arial, sans-serif;
                    max-width: 200px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                
                // æ„å»ºæ‚¬åœæç¤ºæ–‡æœ¬
                const airportName = airport.name || 'æœªçŸ¥æœºåœº';
                const airportCode = airport.code || '';
                const routeCount = airport.routes ? airport.routes.length : 0;
                const airlines = airport.routes ? [...new Set(airport.routes.map(r => r.airline))].filter(a => a && a.trim()) : [];
                
                popoverContent.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">${airportName}</div>
                    ${airportCode ? `<div style="color: #ccc; margin-bottom: 4px;">ä»£ç : ${airportCode}</div>` : ''}
                    <div style="color: #ccc; margin-bottom: 4px;">ç±»å‹: ${roleText}æœºåœº</div>
                    <div style="color: #ccc; margin-bottom: 4px;">èˆªçº¿æ•°: ${routeCount}</div>
                    ${airlines.length > 0 ? `<div style="color: #ccc; font-size: 10px;">èˆªå¸: ${airlines.slice(0, 3).join(', ')}${airlines.length > 3 ? '...' : ''}</div>` : ''}
                `;
                
                popover.appendChild(popoverContent);
                
                // ä½¿ç”¨3Dåœ°å›¾ä¸“ç”¨çš„Marker3DInteractiveElementä»¥æ”¯æŒæ›´å¤šäº‹ä»¶
                const marker = new window.google.maps.maps3d.Marker3DInteractiveElement({
                    position: {
                        lat: airport.lat,
                        lng: airport.lng,
                        altitude: 200 // å¢åŠ é«˜åº¦ï¼Œä½¿æ ‡è®°æ›´åŠ çªå‡º
                    },
                    altitudeMode: "ABSOLUTE",
                    extruded: true,
                    label: glyphText, // ä½¿ç”¨labelå±æ€§æ˜¾ç¤ºæ–‡æœ¬
                    gmpPopoverTargetElement: popover
                });
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                marker.addEventListener('gmp-click', () => {
                    showAirportInfo(airport);
                });
                
                // å­˜å‚¨æœºåœºæ•°æ®åˆ°æ ‡è®°å…ƒç´ ï¼Œä¾¿äºåç»­è®¿é—®
                marker.airportData = airport;
                
                // å°†æ ‡è®°å’Œå¼¹å‡ºæ¡†æ·»åŠ åˆ°åœ°å›¾
                map3d.appendChild(marker);
                map3d.appendChild(popover);
                
                console.log(`âœˆï¸ æœºåœºæ ‡è®°åˆ›å»ºæˆåŠŸ: ${airport.name || airport.code} (${airport.code}) - è§’è‰²: ${roleText} - ä½ç½®: ${airport.lat}, ${airport.lng}`);
                return marker;
                
            } catch (error) {
                console.error('åˆ›å»ºæœºåœºæ ‡è®°å¤±è´¥:', error, airport);
                return null;
            }
        }
        
        // æ˜¾ç¤ºæœºåœºè¯¦ç»†ä¿¡æ¯ - å¢å¼ºç‰ˆæœ¬
        function showAirportInfo(airport) {
            try {
                const importRoutes = airport.routes ? airport.routes.filter(r => r.direction === 'è¿›å£') : [];
                const exportRoutes = airport.routes ? airport.routes.filter(r => r.direction === 'å‡ºå£') : [];
                const airlines = airport.routes ? [...new Set(airport.routes.map(r => r.airline))].filter(a => a && a.trim()) : [];
                
                // æ„å»ºè¯¦ç»†çš„èˆªçº¿ä¿¡æ¯
                let routeDetails = '';
                if (importRoutes.length > 0) {
                    routeDetails += '\n\nè¿›å£èˆªçº¿è¯¦æƒ…:';
                    importRoutes.forEach((route, index) => {
                        routeDetails += `\n  ${index + 1}. ${route.start_airport || route.start_city || 'æœªçŸ¥'} â†’ ${route.end_airport || route.end_city || 'æœªçŸ¥'}`;
                        if (route.airline) routeDetails += ` (${route.airline})`;
                        if (route.cargo_type) routeDetails += ` - ${route.cargo_type}`;
                    });
                }
                
                if (exportRoutes.length > 0) {
                    routeDetails += '\n\nå‡ºå£èˆªçº¿è¯¦æƒ…:';
                    exportRoutes.forEach((route, index) => {
                        routeDetails += `\n  ${index + 1}. ${route.start_airport || route.start_city || 'æœªçŸ¥'} â†’ ${route.end_airport || route.end_city || 'æœªçŸ¥'}`;
                        if (route.airline) routeDetails += ` (${route.airline})`;
                        if (route.cargo_type) routeDetails += ` - ${route.cargo_type}`;
                    });
                }
                
                const info = `ğŸ›« æœºåœºè¯¦ç»†ä¿¡æ¯

æœºåœºåç§°: ${airport.name || 'æœªçŸ¥æœºåœº'}
æœºåœºä»£ç : ${airport.code || 'æ— '}
åæ ‡ä½ç½®: ${airport.lat?.toFixed(4) || 'æœªçŸ¥'}, ${airport.lng?.toFixed(4) || 'æœªçŸ¥'}

ğŸ“Š èˆªçº¿ç»Ÿè®¡:
â€¢ æ€»èˆªçº¿æ•°: ${airport.routes ? airport.routes.length : 0} æ¡
â€¢ è¿›å£èˆªçº¿: ${importRoutes.length} æ¡
â€¢ å‡ºå£èˆªçº¿: ${exportRoutes.length} æ¡
â€¢ æ¶‰åŠèˆªå¸: ${airlines.length > 0 ? airlines.join(', ') : 'æ— '}${routeDetails}`;
                
                console.log('æœºåœºè¯¦ç»†ä¿¡æ¯:', info);
                
                // åˆ›å»ºä¸€ä¸ªæ›´ç¾è§‚çš„ä¿¡æ¯æ˜¾ç¤ºçª—å£
                const shouldShowDetails = window.confirm(info + '\n\næ˜¯å¦åœ¨æ§åˆ¶å°æŸ¥çœ‹æ›´å¤šæŠ€æœ¯è¯¦æƒ…ï¼Ÿ');
                if (shouldShowDetails) {
                    console.group(`ğŸ›« ${airport.name || airport.code} æœºåœºæŠ€æœ¯è¯¦æƒ…`);
                    console.log('å®Œæ•´æœºåœºæ•°æ®:', airport);
                    if (airport.routes && airport.routes.length > 0) {
                        console.log('å…³è”èˆªçº¿æ•°æ®:', airport.routes);
                    }
                    console.groupEnd();
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºæœºåœºä¿¡æ¯æ—¶å‡ºé”™:', error);
            }
        }
        
        // æ·»åŠ èˆªçº¿
        function addRoutes(routes) {
            if (!window.google || !window.google.maps || !window.google.maps.maps3d) {
                console.error('Google Maps 3D APIæœªåŠ è½½');
                return;
            }
            
            let validRoutes = 0;
            let invalidRoutes = 0;
            
            routes.forEach((route, index) => {
                if (isValidRoute(route)) {
                    try {
                        const polyline = createRoutePolyline(route, index);
                        if (polyline) {
                            routeElements.set(`route_${index}`, polyline);
                            map3d.appendChild(polyline);
                            validRoutes++;
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºèˆªçº¿å¤±è´¥:', error, route);
                        invalidRoutes++;
                    }
                } else {
                    invalidRoutes++;
                }
            });
            
            console.log(`èˆªçº¿åŠ è½½å®Œæˆ: æœ‰æ•ˆ ${validRoutes} æ¡, æ— æ•ˆ ${invalidRoutes} æ¡`);
            
            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆèˆªçº¿ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (validRoutes === 0 && routes.length > 0) {
                console.warn('æ‰€æœ‰èˆªçº¿æ•°æ®éƒ½æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
                updateLoadingStatus('èˆªçº¿æ•°æ®æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
            }
        }
        
        // åˆ›å»ºèˆªçº¿å¤šæ®µçº¿
        function createRoutePolyline(route, index) {
            const polyline = new google.maps.maps3d.Polyline3DElement();
            
            // è®¾ç½®åæ ‡
            const startCoord = {
                lat: parseFloat(route.start_lat),
                lng: parseFloat(route.start_lng),
                altitude: 8000
            };
            const endCoord = {
                lat: parseFloat(route.end_lat),
                lng: parseFloat(route.end_lng),
                altitude: 8000
            };
            
            // æ ¹æ®è¿›å‡ºå£æ–¹å‘è®¾ç½®åæ ‡é¡ºåº
            let coordinates;
            if (route.direction === 'è¿›å£') {
                // è¿›å£ï¼šä»ç›®çš„åœ°åˆ°èµ·å§‹åœ°
                coordinates = [endCoord, startCoord];
            } else {
                // å‡ºå£ï¼šä»èµ·å§‹åœ°åˆ°ç›®çš„åœ°
                coordinates = [startCoord, endCoord];
            }
            
            polyline.coordinates = coordinates;
            
            // è®¾ç½®æ ·å¼
            polyline.strokeColor = getRouteColor(route);
            polyline.strokeWidth = getRouteWidth(route);
            polyline.strokeOpacity = 0.8;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            if (animationEnabled) {
                addRouteAnimation(polyline, route, index);
            }
            
            return polyline;
        }
        
        // æ·»åŠ èˆªçº¿åŠ¨ç”»æ•ˆæœ
        function addRouteAnimation(polyline, route, index) {
            // å»¶è¿Ÿå¯åŠ¨åŠ¨ç”»ï¼Œé¿å…æ‰€æœ‰èˆªçº¿åŒæ—¶å¼€å§‹
            const delay = (index % 20) * 100; // æ¯20æ¡èˆªçº¿ä¸ºä¸€ç»„ï¼Œç»„å†…é—´éš”100ms
            
            setTimeout(() => {
                // åˆ›å»ºåŠ¨ç”»ç‚¹
                const animationDot = createAnimationDot(route);
                if (animationDot) {
                    map3d.appendChild(animationDot);
                    
                    // å¯åŠ¨åŠ¨ç”»
                    startRouteAnimation(animationDot, polyline.coordinates, route);
                    
                    // å°†åŠ¨ç”»ç‚¹ä¸èˆªçº¿å…³è”
                    const routeKey = `route_${index}`;
                    if (!routeElements.has(routeKey + '_animation')) {
                        routeElements.set(routeKey + '_animation', animationDot);
                    }
                }
            }, delay);
        }
        
        // åˆ›å»ºåŠ¨ç”»ç‚¹
        function createAnimationDot(route) {
            const marker = new google.maps.maps3d.Marker3DElement();
            
            // è®¾ç½®åˆå§‹ä½ç½®
            const startCoord = route.direction === 'è¿›å£' 
                ? { lat: parseFloat(route.end_lat), lng: parseFloat(route.end_lng), altitude: 8000 }
                : { lat: parseFloat(route.start_lat), lng: parseFloat(route.start_lng), altitude: 8000 };
            
            marker.position = startCoord;
            
            // åˆ›å»ºåŠ¨ç”»ç‚¹æ ·å¼
            const dot = document.createElement('div');
            const color = getRouteColor(route);
            dot.style.cssText = `
                width: 6px;
                height: 6px;
                background-color: ${color};
                border: 1px solid white;
                border-radius: 50%;
                box-shadow: 0 0 10px ${color};
                animation: pulse 1s infinite;
            `;
            
            // æ·»åŠ è„‰å†²åŠ¨ç”»CSS
            if (!document.getElementById('animation-styles')) {
                const style = document.createElement('style');
                style.id = 'animation-styles';
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.5); opacity: 0.7; }
                        100% { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            marker.appendChild(dot);
            return marker;
        }
        
        // å¯åŠ¨èˆªçº¿åŠ¨ç”»
        function startRouteAnimation(animationDot, coordinates, route) {
            if (coordinates.length < 2) return;
            
            const startCoord = coordinates[0];
            const endCoord = coordinates[1];
            
            // è®¡ç®—åŠ¨ç”»æ­¥æ•°
            const steps = 50;
            const stepDelay = animationSpeed / steps;
            let currentStep = 0;
            
            const animate = () => {
                if (currentStep >= steps) {
                    // åŠ¨ç”»å®Œæˆï¼Œé‡æ–°å¼€å§‹
                    currentStep = 0;
                    setTimeout(() => {
                        if (animationEnabled && animationDot.parentNode) {
                            animate();
                        }
                    }, 1000); // æš‚åœ1ç§’åé‡æ–°å¼€å§‹
                    return;
                }
                
                // è®¡ç®—å½“å‰ä½ç½®
                const progress = currentStep / steps;
                const lat = startCoord.lat + (endCoord.lat - startCoord.lat) * progress;
                const lng = startCoord.lng + (endCoord.lng - startCoord.lng) * progress;
                const altitude = startCoord.altitude + (endCoord.altitude - startCoord.altitude) * progress;
                
                // æ›´æ–°ä½ç½®
                animationDot.position = { lat, lng, altitude };
                
                currentStep++;
                setTimeout(animate, stepDelay);
            };
            
            animate();
        }
        
        // è·å–èˆªçº¿é¢œè‰²
        function getRouteColor(route) {
            // æ ¹æ®è¿›å‡ºå£æ–¹å‘è®¾ç½®é¢œè‰²
            const direction = route.direction || 'å‡ºå£';
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºåŒå‘èˆªçº¿
            if (route.is_bidirectional || route.bidirectional) {
                return '#9C27B0'; // ç´«è‰² - åŒå‘èˆªçº¿
            }
            
            if (direction === 'è¿›å£') {
                return '#4CAF50'; // ç»¿è‰² - è¿›å£èˆªçº¿
            } else {
                return '#FF5722'; // æ©™çº¢è‰² - å‡ºå£èˆªçº¿
            }
        }
        
        // è·å–èˆªçº¿å®½åº¦
        function getRouteWidth(route) {
            const frequency = route.frequency || 1;
            return Math.max(2, Math.min(6, frequency));
        }
        
        // éªŒè¯èˆªçº¿æ•°æ® - æ”¾å®½éªŒè¯æ¡ä»¶
        function isValidRoute(route) {
            if (!route) {
                console.warn('èˆªçº¿æ•°æ®ä¸ºç©º');
                return false;
            }
            
            // æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºnull/undefined
            const requiredFields = ['start_lat', 'start_lng', 'end_lat', 'end_lng'];
            for (let field of requiredFields) {
                if (route[field] === undefined || route[field] === null) {
                    console.warn(`èˆªçº¿æ•°æ®ç¼ºå°‘å­—æ®µ: ${field}`, route);
                    return false;
                }
            }
            
            // å°è¯•è½¬æ¢ä¸ºæ•°å­—
            try {
                const startLat = parseFloat(route.start_lat);
                const startLng = parseFloat(route.start_lng);
                const endLat = parseFloat(route.end_lat);
                const endLng = parseFloat(route.end_lng);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                if (isNaN(startLat) || isNaN(startLng) || isNaN(endLat) || isNaN(endLng)) {
                    console.warn('èˆªçº¿åæ ‡æ— æ³•è½¬æ¢ä¸ºæ•°å­—:', route);
                    return false;
                }
                
                // æ£€æŸ¥åæ ‡èŒƒå›´
                if (Math.abs(startLat) > 90 || Math.abs(endLat) > 90) {
                    console.warn('çº¬åº¦è¶…å‡ºèŒƒå›´:', route);
                    return false;
                }
                
                if (Math.abs(startLng) > 180 || Math.abs(endLng) > 180) {
                    console.warn('ç»åº¦è¶…å‡ºèŒƒå›´:', route);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('éªŒè¯èˆªçº¿æ•°æ®æ—¶å‡ºé”™:', error, route);
                return false;
            }
        }
        
        // è°ƒæ•´è§†è§’ä»¥é€‚åº”æ•°æ®
        function fitBounds(routes) {
            if (!routes || routes.length === 0) return;
            
            let north = -90, south = 90, east = -180, west = 180;
            
            routes.forEach(route => {
                if (isValidRoute(route)) {
                    north = Math.max(north, route.start_lat, route.end_lat);
                    south = Math.min(south, route.start_lat, route.end_lat);
                    east = Math.max(east, route.start_lng, route.end_lng);
                    west = Math.min(west, route.start_lng, route.end_lng);
                }
            });
            
            const center = {
                lat: (north + south) / 2,
                lng: (east + west) / 2,
                altitude: 0
            };
            
            const latDiff = north - south;
            const lngDiff = east - west;
            const maxDiff = Math.max(latDiff, lngDiff);
            const range = Math.max(maxDiff * 111000 * 2, 100000);
            
            map3d.flyCameraTo({
                endCamera: {
                    center: center,
                    heading: 0,
                    tilt: 45,
                    range: range
                },
                durationMillis: 1500
            });
        }
        
        // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ•°æ®æ›´æ–°æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'update-routes') {
                console.log('æ”¶åˆ°æ•°æ®æ›´æ–°æ¶ˆæ¯');
                updateRoutes(event.data.routes);
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–3Dåœ°å›¾');
            setTimeout(initMap3D, 500);
        });
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('é¡µé¢é”™è¯¯:', event.error);
        });
        
        // æ§åˆ¶é¢æ¿åŠŸèƒ½å‡½æ•°
        function toggleAnimation() {
            const toggle = document.getElementById('animation-toggle');
            animationEnabled = toggle.checked;
            console.log('åŠ¨ç”»æ•ˆæœ:', animationEnabled ? 'å¼€å¯' : 'å…³é—­');
            
            if (!animationEnabled) {
                // æ¸…é™¤æ‰€æœ‰åŠ¨ç”»ç‚¹
                routeElements.forEach((element, key) => {
                    if (key.includes('_animation') && element && element.remove) {
                        element.remove();
                    }
                });
                // æ¸…ç†åŠ¨ç”»ç‚¹çš„å¼•ç”¨
                const animationKeys = Array.from(routeElements.keys()).filter(key => key.includes('_animation'));
                animationKeys.forEach(key => routeElements.delete(key));
            } else {
                // é‡æ–°æ·»åŠ åŠ¨ç”»
                if (currentRoutes && currentRoutes.length > 0) {
                    currentRoutes.forEach((route, index) => {
                        if (isValidRoute(route)) {
                            const routeKey = `route_${index}`;
                            const polyline = routeElements.get(routeKey);
                            if (polyline) {
                                addRouteAnimation(polyline, route, index);
                            }
                        }
                    });
                }
            }
        }
        
        function updateAnimationSpeed() {
            const speedSlider = document.getElementById('animation-speed');
            animationSpeed = parseInt(speedSlider.value);
            console.log('åŠ¨ç”»é€Ÿåº¦æ›´æ–°ä¸º:', animationSpeed, 'ms');
        }
        
        function toggleAirports() {
            const toggle = document.getElementById('airport-toggle');
            const showAirports = toggle.checked;
            console.log('æœºåœºæ˜¾ç¤º:', showAirports ? 'å¼€å¯' : 'å…³é—­');
            
            airportMarkers.forEach(marker => {
                try {
                    if (marker) {
                        if (showAirports) {
                            if (!marker.parentNode && map3d) {
                                map3d.appendChild(marker);
                            }
                        } else {
                            if (marker.parentNode) {
                                marker.parentNode.removeChild(marker);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('åˆ‡æ¢æœºåœºæ ‡è®°æ˜¾ç¤ºçŠ¶æ€æ—¶å‡ºé”™:', error.message);
                }
            });
        }
        
        console.log('ä¼˜åŒ–çš„3Dåœ°å›¾ç»„ä»¶å·²åŠ è½½');
        console.log('é…ç½®ä¿¡æ¯:', CONFIG);
        console.log('åˆå§‹èˆªçº¿æ•°æ®:', ROUTE_DATA.length, 'æ¡');
    </script>
</body>
</html>
