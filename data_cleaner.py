# D:\flight_tool\data_cleaner.py
import pandas as pd
import re
from typing import List, Dict, Set

# å®šä¹‰æœ‰æ•ˆçš„åŸå¸‚åç§°æ˜ å°„å’Œæ¸…ç†è§„åˆ™
CITY_NAME_MAPPING = {
    # æœºåœºåç§°åˆ°åŸå¸‚åç§°çš„æ˜ å°„ï¼ˆç¡®ä¿æ˜ å°„åçš„åŸå¸‚åœ¨ç›¸åº”åˆ—è¡¨ä¸­å­˜åœ¨ï¼‰
    'ç­è¾¾æ‹‰å¥ˆå…‹': 'ç§‘ä¼¦å¡',
    'è‹±è¿ªæ‹‰ç”˜åœ°': 'æ–°å¾·é‡Œ',
    'è´¾ç‰¹æ‹‰å¸•è’‚å¸Œç“¦': 'å­Ÿä¹°', 
    'è¾¾å¡æ²™é˜¿è´¾æ‹‰å‹’': 'è¾¾å¡',
    'è‚¯ä½©æˆˆè¾¾': 'ç­åŠ ç½—å°”',
    'é˜¿æ‹‰ç›ä¼Šå…‹å·´å°”': 'æ‹‰åˆå°”',
    'æ‰è€¶å¾·': 'é˜¿å¸ƒæ‰æ¯”',
    'å®‰å…‹é›·å¥‡': 'å®‰å…‹é›·å¥‡',
    'åšä¹é˜¿æ‹‰å±±å£': 'åšä¹',
    # ç›´æ¥ä½¿ç”¨åŸåç§°ï¼Œé¿å…æ˜ å°„é—®é¢˜
    'åˆ—æ—¥': 'åˆ—æ—¥',
    'å¸ƒè¾¾ä½©æ–¯': 'å¸ƒè¾¾ä½©æ–¯',
    'é‡‘å¥ˆ': 'é‡‘å¥ˆ',
    'ä¸œäº¬': 'ä¸œäº¬',
    'é¦–å°”': 'é¦–å°”',
    'æ–°åŠ å¡': 'æ–°åŠ å¡',
    
    # æ ‡å‡†åŒ–åŸå¸‚åç§°
    'åŒ—äº¬': 'åŒ—äº¬',
    'ä¸Šæµ·': 'ä¸Šæµ·',
    'å¹¿å·': 'å¹¿å·',
    'æ·±åœ³': 'æ·±åœ³',
    'æˆéƒ½': 'æˆéƒ½',
    'é‡åº†': 'é‡åº†',
    'æ­å·': 'æ­å·',
    'å—äº¬': 'å—äº¬',
    'æ­¦æ±‰': 'æ­¦æ±‰',
    'è¥¿å®‰': 'è¥¿å®‰',
    'æ˜†æ˜': 'æ˜†æ˜',
    'éƒ‘å·': 'éƒ‘å·',
    'é•¿æ²™': 'é•¿æ²™',
    'æ²ˆé˜³': 'æ²ˆé˜³',
    'å¤§è¿': 'å¤§è¿',
    'é’å²›': 'é’å²›',
    'å¤©æ´¥': 'å¤©æ´¥',
    'æµ·å£': 'æµ·å£',
    'è´µé˜³': 'è´µé˜³',
    'å…°å·': 'å…°å·',
    'ä¹Œé²æœ¨é½': 'ä¹Œé²æœ¨é½',
    'å“ˆå°”æ»¨': 'å“ˆå°”æ»¨',
    'é•¿æ˜¥': 'é•¿æ˜¥',
    'å—å®': 'å—å®',
    
    # å¸¸è§æ‹¼å†™é”™è¯¯æ˜ å°„
    'æ—¥æœ¬å¤§ç‰ˆ': 'å¤§é˜ª',
    'æ—¥æœ¬å¤§å‚': 'å¤§é˜ª',
    'å—é€š': 'å—é€š',
    'æ— é”¡': 'æ— é”¡',
    'å®æ³¢': 'å®æ³¢',
    'æ½åŠ': 'æ½åŠ',
    'çƒŸå°': 'çƒŸå°',
    'é„‚å·': 'é„‚å·',
    
    # å›½é™…åŸå¸‚
    'ä¸œäº¬': 'ä¸œäº¬',
    'å¤§é˜ª': 'å¤§é˜ª',
    'é¦–å°”': 'é¦–å°”',
    'å°åŒ—': 'å°åŒ—',
    'é¦™æ¸¯': 'é¦™æ¸¯',
    'æ–°åŠ å¡': 'æ–°åŠ å¡',
    'å‰éš†å¡': 'å‰éš†å¡',
    'é©¬å°¼æ‹‰': 'é©¬å°¼æ‹‰',
    'èƒ¡å¿—æ˜': 'èƒ¡å¿—æ˜å¸‚',
    'é‡‘å¥ˆ': 'é‡‘å¥ˆ',
    'æ³•å…°å…‹ç¦': 'æ³•å…°å…‹ç¦',
    'åˆ—æ—¥': 'åˆ—æ—¥',
    'å¸ƒè¾¾ä½©æ–¯': 'å¸ƒè¾¾ä½©æ–¯',
    'å¥¥æ–¯é™†': 'å¥¥æ–¯é™†',
    'æ´›æ‰çŸ¶': 'æ´›æ‰çŸ¶',
    'çº½çº¦': 'çº½çº¦',
    'å“ˆåˆ©æ³•å…‹æ–¯': 'å“ˆåˆ©æ³•å…‹æ–¯',
    'å¡æ‹‰å¹²è¾¾': 'å¡æ‹‰å¹²è¾¾',
    'é˜¿æ‹‰æœ¨å›¾': 'é˜¿æ‹‰æœ¨å›¾',
    'ç¬¬æ¯”åˆ©æ–¯': 'ç¬¬æ¯”åˆ©æ–¯',
    'ä¼Šæ–¯å…°å ¡': 'ä¼Šæ–¯å…°å ¡',
    
    # æœºåœºå…¨ååˆ°åŸå¸‚åç§°çš„æ˜ å°„
    'æ˜†æ˜é•¿æ°´': 'æ˜†æ˜',
    'æ¸©å·é¾™æ¹¾': 'æ¸©å·',
    'æ­å·è§å±±': 'æ­å·',
    'é©¬å°¼æ‹‰å°¼è¯ºé˜¿åŸºè¯º': 'é©¬å°¼æ‹‰',
    'é¦–å°”ä»å·': 'é¦–å°”',
    'è‹å·´æ–¯Â·é’±å¾·æ‹‰Â·é²æ–¯': 'ç§‘ä¼¦å¡',
    'è‹å·´æ–¯Â·é’±å¾·æ‹‰Â·é²æ–¯-é˜¿å‹’é©¬å…‹å›¾å§†': 'ç§‘ä¼¦å¡',
    'é˜¿å‹’é©¬å…‹å›¾å§†': 'è¿ªæ‹œ',
    'åŠªå°”è‹ä¸¹çº³æ‰å°”å·´è€¶å¤«': 'é˜¿æ–¯å¡”çº³',
    'åŠªå°”è‹ä¸¹çº³æ‰å°”å·´è€¶å¤«-å¸ƒè¾¾ä½©æ–¯': 'é˜¿æ–¯å¡”çº³',
    'è¾¾å¡æ²™é˜¿è´¾æ‹‰å‹’': 'è¾¾å¡',
    'å¸ƒè¾¾ä½©æ–¯': 'å¸ƒè¾¾ä½©æ–¯',
    'ä¸œäº¬æˆç”°': 'ä¸œäº¬',
    # ä¿®å¤ä¸­è´§èˆªç¼ºå¤±çš„åŸå¸‚æ˜ å°„
    'ä¸Šæµ·æµ¦ä¸œ': 'ä¸Šæµ·',
    'çº½çº¦è‚¯å°¼è¿ª': 'çº½çº¦',
    'ä¼¦æ•¦æ–¯å¦æ–¯ç‰¹å¾·': 'ä¼¦æ•¦',
    'ä¼¦æ•¦æ–¯å¡”æ–¯ç‰¹å¾·': 'ä¼¦æ•¦'
}

# æ— æ•ˆæ•°æ®æ¨¡å¼
INVALID_PATTERNS = [
    r'^\d+ERç±»ä¼¼$',  # å¦‚ 338ERç±»ä¼¼
    r'^[A-Z0-9]+$',   # çº¯å¤§å†™å­—æ¯æ•°å­—ç»„åˆ
    r'^\s*$',         # ç©ºç™½
    r'^nan$',         # NaNå€¼
    r'^null$',        # nullå€¼
]

# å›½å†…åŸå¸‚åˆ—è¡¨
DOMESTIC_CITIES = {
    # ç›´è¾–å¸‚
    'åŒ—äº¬', 'ä¸Šæµ·', 'å¤©æ´¥', 'é‡åº†',
    # çœä¼šåŠé‡è¦åŸå¸‚
    'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½', 'æ­å·', 'å—äº¬', 'æ­¦æ±‰', 'è¥¿å®‰', 'æ˜†æ˜', 'éƒ‘å·', 'é•¿æ²™',
    'æ²ˆé˜³', 'å¤§è¿', 'é’å²›', 'æµ·å£', 'è´µé˜³', 'å…°å·', 'ä¹Œé²æœ¨é½', 'å“ˆå°”æ»¨', 'é•¿æ˜¥', 'å—å®',
    'å—é€š', 'æ— é”¡', 'å®æ³¢', 'æ½åŠ', 'çƒŸå°', 'é„‚å·', 'çŸ³å®¶åº„', 'å¤ªåŸ', 'å‘¼å’Œæµ©ç‰¹',
    'åˆè‚¥', 'ç¦å·', 'å—æ˜Œ', 'æµå—', 'é“¶å·', 'è¥¿å®', 'æ‹‰è¨',
    # å…¶ä»–é‡è¦åŸå¸‚
    'è‹å·', 'æ¸©å·', 'å¦é—¨', 'æ³‰å·', 'ä½›å±±', 'ä¸œè', 'ä¸­å±±', 'ç æµ·', 'æ±•å¤´', 'æ¹›æ±Ÿ',
    'æƒ å·', 'æ±Ÿé—¨', 'èŒ‚å', 'è‚‡åº†', 'æ¢…å·', 'éŸ¶å…³', 'æ²³æº', 'é˜³æ±Ÿ', 'æ¸…è¿œ', 'æ½®å·',
    'æ­é˜³', 'äº‘æµ®', 'æ±•å°¾', 'å®œæ˜Œ', 'è¥„é˜³', 'è†å·', 'é»„å†ˆ', 'å­æ„Ÿ', 'åå °', 'éšå·',
    'æ©æ–½', 'é»„çŸ³', 'å’¸å®', 'é„‚å·', 'è†é—¨', 'ä»™æ¡ƒ', 'æ½œæ±Ÿ', 'å¤©é—¨', 'ç¥å†œæ¶',
    # è¡¥å……ç¼ºå¤±çš„å›½å†…åŸå¸‚
    'èŠœæ¹–', 'ç›åŸ', 'æ·®å®‰', 'è¿äº‘æ¸¯', 'æ‰¬å·', 'é•‡æ±Ÿ', 'æ³°å·', 'å®¿è¿',
    'å˜‰å…´', 'æ¹–å·', 'ç»å…´', 'é‡‘å', 'è¡¢å·', 'èˆŸå±±', 'å°å·', 'ä¸½æ°´',
    'èšŒåŸ ', 'æ·®å—', 'é©¬éå±±', 'æ·®åŒ—', 'é“œé™µ', 'å®‰åº†', 'é»„å±±', 'æ»å·',
    'é˜œé˜³', 'å®¿å·', 'å…­å®‰', 'äº³å·', 'æ± å·', 'å®£åŸ'
}

# å›½é™…åŸå¸‚åˆ—è¡¨
INTERNATIONAL_CITIES = {
    # äºšæ´²
    'ä¸œäº¬', 'å¤§é˜ª', 'åå¤å±‹', 'ç¦å†ˆ', 'æœ­å¹Œ', 'ä»™å°', 'å…³è¥¿', 'æˆç”°', 'ç¾½ç”°',
    'é¦–å°”', 'é‡œå±±', 'æµå·', 'ä»å·',
    'å°åŒ—', 'é«˜é›„', 'å°ä¸­', 'æ¡ƒå›­',
    'é¦™æ¸¯', 'æ¾³é—¨',
    'æ–°åŠ å¡', 'æ¨Ÿå®œ',
    'å‰éš†å¡', 'æ§ŸåŸ', 'äºšåº‡',
    'é©¬å°¼æ‹‰', 'å®¿åŠ¡', 'å…‹æ‹‰å…‹',
    'èƒ¡å¿—æ˜å¸‚', 'æ²³å†…', 'å²˜æ¸¯',
    'æ›¼è°·', 'æ™®å‰', 'æ¸…è¿ˆ',
    'é›…åŠ è¾¾', 'å·´å˜å²›', 'æ³—æ°´',
    'é‡‘å¥ˆ', 'ç§‘ä¼¦å¡', 'æ–°å¾·é‡Œ', 'å­Ÿä¹°', 'è¾¾å¡', 'ç­åŠ ç½—å°”', 'æ‹‰åˆå°”', 'å¡æ‹‰å¥‡',
    'ä¼Šæ–¯å…°å ¡', 'åŠ å¾·æ»¡éƒ½', 'ç§‘å¨ç‰¹', 'å¤šå“ˆ', 'è¿ªæ‹œ', 'é˜¿å¸ƒæ‰æ¯”', 'æ²™è¿¦',
    'åˆ©é›…å¾—', 'å‰è¾¾', 'è¾¾æ›¼', 'éº¦åœ°é‚£',
    # æ¬§æ´²
    'æ³•å…°å…‹ç¦', 'æ…•å°¼é»‘', 'æŸæ—', 'æ±‰å ¡', 'æœå¡å°”å¤šå¤«', 'ç§‘éš†',
    'ä¼¦æ•¦', 'æ›¼å½»æ–¯ç‰¹', 'çˆ±ä¸å ¡', 'æ ¼æ‹‰æ–¯å“¥', 'ä¸œç±³å¾·å…°å…¹', 'æ–¯å¦æ–¯ç‰¹å¾·',
    'å·´é»', 'é‡Œæ˜‚', 'é©¬èµ›', 'å°¼æ–¯', 'æˆ´é«˜ä¹',
    'é˜¿å§†æ–¯ç‰¹ä¸¹', 'é¹¿ç‰¹ä¸¹',
    'å¸ƒé²å¡å°”', 'åˆ—æ—¥', 'å®‰ç‰¹å«æ™®',
    'è‹é»ä¸–', 'æ—¥å†…ç“¦', 'å·´å¡å°”',
    'ç»´ä¹Ÿçº³', 'è¨å°”èŒ¨å ¡',
    'ç½—é©¬', 'ç±³å…°', 'å¨å°¼æ–¯', 'é‚£ä¸å‹’æ–¯',
    'é©¬å¾·é‡Œ', 'å·´å¡ç½—é‚£', 'å¡ç»´åˆ©äºš',
    'é‡Œæ–¯æœ¬', 'æ³¢å°”å›¾',
    'æ–¯å¾·å“¥å°”æ‘©', 'å“¥å¾·å ¡', 'å¥¥æ–¯é™†', 'å‘å°”æ ¹', 'èµ«å°”è¾›åŸº',
    'å“¥æœ¬å“ˆæ ¹', 'å¥¥èƒ¡æ–¯',
    'åæ²™', 'å…‹æ‹‰ç§‘å¤«', 'æ ¼ä½†æ–¯å…‹',
    'å¸ƒæ‹‰æ ¼', 'å¸ƒå°”è¯º',
    'å¸ƒè¾¾ä½©æ–¯', 'å¾·å¸ƒå‹’æ£®',
    'å¸ƒåŠ å‹’æ–¯ç‰¹', 'åº·æ–¯å¦å¯Ÿ',
    'ç´¢éäºš', 'æ™®ç½—å¤«è¿ªå¤«',
    'è´å°”æ ¼è±å¾·', 'è¯ºç»´è¨å¾·',
    'è¨æ ¼å‹’å¸ƒ', 'æ–¯æ™®åˆ©ç‰¹',
    'å¢å¸ƒå°”é›…é‚£', 'é©¬é‡Œåšå°”',
    'å¡”æ—', 'é‡ŒåŠ ', 'ç»´å°”çº½æ–¯',
    'è«æ–¯ç§‘', 'åœ£å½¼å¾—å ¡', 'æ–°è¥¿ä¼¯åˆ©äºš', 'å¶å¡æ·ç³å ¡',
    # åŒ—ç¾æ´²
    'çº½çº¦', 'æ´›æ‰çŸ¶', 'èŠåŠ å“¥', 'æ—§é‡‘å±±', 'è¥¿é›…å›¾', 'æ³¢å£«é¡¿', 'åç››é¡¿',
    'è¿ˆé˜¿å¯†', 'æ‹‰æ–¯ç»´åŠ æ–¯', 'ä¸¹ä½›', 'è¾¾æ‹‰æ–¯', 'ä¼‘æ–¯é¡¿', 'äºšç‰¹å…°å¤§',
    'å¤šä¼¦å¤š', 'æ¸©å“¥å', 'è’™ç‰¹åˆ©å°”', 'å¡å°”åŠ é‡Œ', 'å“ˆåˆ©æ³•å…‹æ–¯',
    'å¢¨è¥¿å“¥åŸ', 'åæ˜†', 'ç“œè¾¾æ‹‰å“ˆæ‹‰',
    # å—ç¾æ´²
    'åœ£ä¿ç½—', 'é‡Œçº¦çƒ­å†…å¢', 'å·´è¥¿åˆ©äºš',
    'å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯', 'ç§‘å°”å¤šç“¦',
    'åœ£åœ°äºšå“¥', 'ç“¦å°”å¸•è±ç´¢',
    'åˆ©é©¬', 'åº“æ–¯ç§‘',
    'æ³¢å“¥å¤§', 'éº¦å¾·æ—',
    'åŸºå¤š', 'ç“œäºšåŸºå°”',
    'åŠ æ‹‰åŠ æ–¯', 'é©¬æ‹‰å¼€æ³¢',
    # éæ´²
    'å¼€ç½—', 'äºšå†å±±å¤§',
    'çº¦ç¿°å†…æ–¯å ¡', 'å¼€æ™®æ•¦', 'å¾·ç­',
    'æ‹‰å„æ–¯', 'é˜¿å¸ƒè´¾',
    'å†…ç½—æ¯•', 'è’™å·´è¨',
    'äºšçš„æ–¯äºšè´å·´', 'é˜¿å…‹æ‹‰',
    'å¡è¨å¸ƒå…°å¡', 'æ‹‰å·´ç‰¹',
    'çªå°¼æ–¯', 'é˜¿å°”åŠå°”',
    # å¤§æ´‹æ´²
    'æ‚‰å°¼', 'å¢¨å°”æœ¬', 'å¸ƒé‡Œæ–¯ç­', 'ç€æ–¯', 'é˜¿å¾·è±å¾·', 'è¾¾å°”æ–‡',
    'å¥¥å…‹å…°', 'æƒ çµé¡¿', 'åŸºç£åŸ',
    # ä¸­äºš
    'å¡æ‹‰å¹²è¾¾', 'é˜¿æ‹‰æœ¨å›¾', 'é˜¿æ–¯å¡”çº³', 'å¥‡å§†è‚¯ç‰¹',
    'å¡”ä»€å¹²', 'æ’’é©¬å°”ç½•', 'å¸ƒå“ˆæ‹‰',
    'æ¯”ä»€å‡¯å…‹', 'å¥¥ä»€',
    'æœå°šåˆ«', 'åº“æ´›å¸ƒ',
    'é˜¿ä»€å“ˆå·´å¾·', 'åœŸåº“æ›¼çº³å·´å¾·',
    'ç¬¬æ¯”åˆ©æ–¯', 'å·´ç»Ÿ',
    'åŸƒé‡Œæ¸©', 'ä¹…å§†é‡Œ',
    'å·´åº“', 'å è´¾',
    # å…¶ä»–
    'å®‰å…‹é›·å¥‡', 'è´¹å°”ç­å…‹æ–¯',
    'åšä¹', 'éœå°”æœæ–¯', 'é˜¿æ‹‰å±±å£',
    # è¡¥å……ç¼ºå¤±çš„å›½é™…åŸå¸‚
    'é˜¿å…‹æ‰˜åˆ«', 'å®¿åŠ¡', 'ç“¦èŒ¨æ‹‰å¤«å“ˆç»´å°”', 'è²åˆ©æ™®å®‰å‰åˆ©æ–¯',
    'ä¹‰ä¹Œ', 'å·´åº“æ¯”çº³', 'å·´åº“æ¯”é’ ', 'è´¾ç‰¹æ‹‰å¸•è’‚å¸Œç“¦',
    'è‹±è¿ªæ‹‰ç”˜åœ°', 'é©¬å¾·é‡Œå·´æ‹‰å“ˆæ–¯', 'æ™®é›·æ–¯è’‚å…‹', 'æ–¯å¦æ–¯ç‰¹å¾·',
    'è‚¯å°¼è¿ª', 'æˆç”°', 'æµ¦ä¸œ', 'ç™½äº‘', 'å’¸é˜³', 'è§å±±', 'é¾™æ¹¾',
    'é•¿æ°´', 'å—é˜³', 'æ™‹æ±Ÿ', 'å…´ä¸œ',
    # æ·»åŠ åœ¨æ•°æ®ä¸­å‘ç°çš„ç¼ºå¤±åŸå¸‚
    'è¾¾å¡', 'ç´ ä¸‡é‚£æ™®', 'å¡æ‹‰å¹²è¾¾', 'å¥¥æ–¯é™†', 'å“¥æœ¬å“ˆæ ¹',
    'å®‰èµ«è±æ–¯', 'å…‹æ‹‰å…‹', 'å¸•æ‹‰å°¼äºšå…‹', 'æ‹‰æ™®æ‹‰æ™®å¸‚',
    'éº¦å…‹å¦', 'é©¬å…‹å¦', 'å°¼è¯ºé˜¿åŸºè¯º', 'é˜¿å‹’é©¬å…‹å›¾å§†',
    'æ‰é˜¿å¸ƒæ‰æ¯”', 'æ§Ÿæ¦”å±¿å·', 'æ§ŸåŸå·', 'ä¸‡å¡”å¸‚',
    'ä¼¦æ•¦æ–¯å¦æ–¯ç‰¹å¾·', 'è‹±æ ¼å…°ä¸œç±³å¾·å…°å…¹', 'å“ˆåˆ©æ³•å…‹æ–¯'
}

def is_valid_city(city_name: str) -> bool:
    """æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„åŸå¸‚åç§°"""
    if not city_name or pd.isna(city_name):
        return False
    
    city_str = str(city_name).strip()
    
    # æ£€æŸ¥æ— æ•ˆæ¨¡å¼
    for pattern in INVALID_PATTERNS:
        if re.match(pattern, city_str, re.IGNORECASE):
            return False
    
    # æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆåŸå¸‚åˆ—è¡¨ä¸­
    normalized_city = normalize_city_name(city_str)
    return normalized_city in (DOMESTIC_CITIES | INTERNATIONAL_CITIES)

def normalize_city_name(city_name: str) -> str:
    """æ ‡å‡†åŒ–åŸå¸‚åç§°"""
    if not city_name or pd.isna(city_name):
        return ''
    
    city_str = str(city_name).strip()
    
    # å»é™¤å¤šä½™ç©ºæ ¼
    city_str = re.sub(r'\s+', '', city_str)
    
    # åº”ç”¨æ˜ å°„
    if city_str in CITY_NAME_MAPPING:
        return CITY_NAME_MAPPING[city_str]
    
    # å¤„ç†å¸¦æœ‰å›½å®¶å‰ç¼€çš„åŸå¸‚åç§°
    # ä¾‹å¦‚: "æ—¥æœ¬ä¸œäº¬" -> "ä¸œäº¬", "éŸ©å›½é¦–å°”" -> "é¦–å°”"
    country_city_patterns = [
        r'^æ—¥æœ¬(.+)$',
        r'^éŸ©å›½(.+)$', 
        r'^ç¾å›½(.+)$',
        r'^å¾·å›½(.+)$',
        r'^è‹±å›½(.+)$',
        r'^æ³•å›½(.+)$',
        r'^è·å…°(.+)$',
        r'^æ¯”åˆ©æ—¶(.+)$',
        r'^ä¸¹éº¦(.+)$',
        r'^æŒªå¨(.+)$',
        r'^ç‘å…¸(.+)$',
        r'^èŠ¬å…°(.+)$',
        r'^æ„å¤§åˆ©(.+)$',
        r'^è¥¿ç­ç‰™(.+)$',
        r'^è‘¡è„ç‰™(.+)$',
        r'^ä¿„ç½—æ–¯(.+)$',
        r'^åŠ æ‹¿å¤§(.+)$',
        r'^æ¾³å¤§åˆ©äºš(.+)$',
        r'^æ–°è¥¿å…°(.+)$',
        r'^æ³°å›½(.+)$',
        r'^è¶Šå—(.+)$',
        r'^é©¬æ¥è¥¿äºš(.+)$',
        r'^æ–°åŠ å¡(.+)$',
        r'^å°åº¦å°¼è¥¿äºš(.+)$',
        r'^è²å¾‹å®¾(.+)$',
        r'^å°åº¦(.+)$',
        r'^å­ŸåŠ æ‹‰(.+)$',
        r'^å·´åŸºæ–¯å¦(.+)$',
        r'^é˜¿è”é…‹(.+)$',
        r'^æ²™ç‰¹é˜¿æ‹‰ä¼¯(.+)$',
        r'^åœŸè€³å…¶(.+)$',
        r'^åŸƒåŠ(.+)$',
        r'^å—é(.+)$',
        r'^è‚¯å°¼äºš(.+)$',
        r'^åŸƒå¡ä¿„æ¯”äºš(.+)$',
        r'^å·´è¥¿(.+)$',
        r'^é˜¿æ ¹å»·(.+)$',
        r'^æ™ºåˆ©(.+)$',
        r'^å“ˆè¨å…‹æ–¯å¦(.+)$',
        r'^ä¹Œå…¹åˆ«å…‹æ–¯å¦(.+)$',
        r'^å‰å°”å‰æ–¯æ–¯å¦(.+)$',
        r'^å¡”å‰å…‹æ–¯å¦(.+)$',
        r'^åœŸåº“æ›¼æ–¯å¦(.+)$',
        r'^é˜¿å¡æ‹œç–†(.+)$',
        r'^æ ¼é²å‰äºš(.+)$',
        r'^äºšç¾å°¼äºš(.+)$'
    ]
    
    for pattern in country_city_patterns:
        match = re.match(pattern, city_str)
        if match:
            extracted_city = match.group(1)
            # æ£€æŸ¥æå–çš„åŸå¸‚åæ˜¯å¦åœ¨æ˜ å°„ä¸­
            if extracted_city in CITY_NAME_MAPPING:
                return CITY_NAME_MAPPING[extracted_city]
            return extracted_city
    
    # å¤„ç†å¤åˆè·¯çº¿åç§°ï¼Œä¾‹å¦‚: "å“ˆè¨å…‹æ–¯å¦å¡æ‹‰å¹²è¾¾å·-æŒªå¨å¥¥æ–¯é™†"
    # å–ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„åŸå¸‚åç§°
    if '-' in city_str:
        parts = city_str.split('-')
        for part in parts:
            part = part.strip()
            # ç›´æ¥æ£€æŸ¥æ˜¯å¦åœ¨æ˜ å°„ä¸­
            if part in CITY_NAME_MAPPING:
                candidate = CITY_NAME_MAPPING[part]
                if candidate in (DOMESTIC_CITIES | INTERNATIONAL_CITIES):
                    return candidate
            # å°è¯•æå–å›½å®¶å‰ç¼€
            for pattern in country_city_patterns:
                match = re.match(pattern, part)
                if match:
                    extracted_city = match.group(1)
                    if extracted_city in CITY_NAME_MAPPING:
                        extracted_city = CITY_NAME_MAPPING[extracted_city]
                    if extracted_city in (DOMESTIC_CITIES | INTERNATIONAL_CITIES):
                        return extracted_city
            # ç›´æ¥æ£€æŸ¥æ˜¯å¦åœ¨åŸå¸‚åˆ—è¡¨ä¸­
            if part in (DOMESTIC_CITIES | INTERNATIONAL_CITIES):
                return part
    
    return city_str

def categorize_city(city_name: str) -> str:
    """åˆ†ç±»åŸå¸‚ä¸ºå›½å†…æˆ–å›½é™…"""
    normalized = normalize_city_name(city_name)
    
    if normalized in DOMESTIC_CITIES:
        return 'å›½å†…'
    elif normalized in INTERNATIONAL_CITIES:
        return 'å›½é™…'
    else:
        return 'æœªçŸ¥'

def remove_duplicates(df: pd.DataFrame) -> pd.DataFrame:
    """å»é™¤é‡å¤çš„èˆªçº¿è®°å½•"""
    if df.empty:
        return df
    
    # å®šä¹‰ç”¨äºå»é‡çš„å…³é”®åˆ—ï¼ˆä¸åŒ…å«airlineï¼Œä¿ç•™ä¸åŒèˆªå¸çš„ç›¸åŒèˆªçº¿ï¼‰
    key_columns = ['origin', 'destination', 'aircraft', 'direction', 'flight_number']
    
    # åªä¿ç•™å­˜åœ¨çš„åˆ—
    existing_key_columns = [col for col in key_columns if col in df.columns]
    
    if not existing_key_columns:
        return df
    
    # è®°å½•å»é‡å‰çš„æ•°é‡
    original_count = len(df)
    
    # å»é‡ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªå‡ºç°çš„è®°å½•
    df_dedup = df.drop_duplicates(subset=existing_key_columns, keep='first')
    
    # è®°å½•å»é‡åçš„æ•°é‡
    dedup_count = len(df_dedup)
    removed_count = original_count - dedup_count
    
    if removed_count > 0:
        print(f"ğŸ”„ æ•°æ®å»é‡å®Œæˆï¼šç§»é™¤äº† {removed_count} æ¡é‡å¤è®°å½•")
        print(f"   åŸå§‹è®°å½•æ•°ï¼š{original_count}")
        print(f"   å»é‡åè®°å½•æ•°ï¼š{dedup_count}")
    else:
        print("âœ… æœªå‘ç°é‡å¤è®°å½•")
    
    return df_dedup

def clean_route_data(df: pd.DataFrame, enable_deduplication: bool = True) -> pd.DataFrame:
    """æ¸…ç†èˆªçº¿æ•°æ®ä¸­çš„å§‹å‘åœ°å’Œç›®çš„åœ°ä¿¡æ¯
    
    Args:
        df: åŸå§‹æ•°æ®DataFrame
        enable_deduplication: æ˜¯å¦å¯ç”¨å»é‡åŠŸèƒ½ï¼Œé»˜è®¤ä¸ºTrue
    """
    if df.empty:
        return df
    
    df_clean = df.copy()
    
    # æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦è¿›è¡Œæ•°æ®å»é‡
    if enable_deduplication:
        df_clean = remove_duplicates(df_clean)
    else:
        print(f"ğŸ“Š ä¿ç•™åŸå§‹æ•°æ®ï¼šå…± {len(df_clean)} æ¡è®°å½•ï¼ˆæœªå»é‡ï¼‰")
    
    # æ¸…ç†å§‹å‘åœ°
    if 'origin' in df_clean.columns:
        # æ ‡å‡†åŒ–åŸå¸‚åç§°
        df_clean['origin'] = df_clean['origin'].apply(normalize_city_name)
        # è¿‡æ»¤æ— æ•ˆåŸå¸‚
        df_clean = df_clean[df_clean['origin'].apply(is_valid_city)]
        # æ·»åŠ å§‹å‘åœ°åˆ†ç±»
        df_clean['origin_category'] = df_clean['origin'].apply(categorize_city)
    
    # æ¸…ç†ç›®çš„åœ°
    if 'destination' in df_clean.columns:
        # æ ‡å‡†åŒ–åŸå¸‚åç§°
        df_clean['destination'] = df_clean['destination'].apply(normalize_city_name)
        # è¿‡æ»¤æ— æ•ˆåŸå¸‚
        df_clean = df_clean[df_clean['destination'].apply(is_valid_city)]
        # æ·»åŠ ç›®çš„åœ°åˆ†ç±»
        df_clean['destination_category'] = df_clean['destination'].apply(categorize_city)
    
    # ç§»é™¤å§‹å‘åœ°å’Œç›®çš„åœ°ç›¸åŒçš„è®°å½•
    if 'origin' in df_clean.columns and 'destination' in df_clean.columns:
        df_clean = df_clean[df_clean['origin'] != df_clean['destination']]
    
    return df_clean

def get_sorted_cities(df: pd.DataFrame, column: str) -> List[str]:
    """è·å–æ’åºåçš„åŸå¸‚åˆ—è¡¨ï¼Œå›½å†…åŸå¸‚åœ¨å‰ï¼Œå›½é™…åŸå¸‚åœ¨å"""
    if column not in df.columns:
        return []
    
    cities = df[column].dropna().unique()
    valid_cities = [city for city in cities if is_valid_city(city)]
    
    # åˆ†ç±»æ’åº
    domestic = sorted([city for city in valid_cities if categorize_city(city) == 'å›½å†…'])
    international = sorted([city for city in valid_cities if categorize_city(city) == 'å›½é™…'])
    
    return domestic + international

def print_data_summary(df: pd.DataFrame):
    """æ‰“å°æ•°æ®æ¸…ç†æ‘˜è¦"""
    print("\n=== æ•°æ®æ¸…ç†æ‘˜è¦ ===")
    print(f"æ€»èˆªçº¿æ•°: {len(df)}")
    
    if 'origin' in df.columns:
        origins = get_sorted_cities(df, 'origin')
        domestic_origins = [city for city in origins if categorize_city(city) == 'å›½å†…']
        international_origins = [city for city in origins if categorize_city(city) == 'å›½é™…']
        
        print(f"\nå§‹å‘åœ°ç»Ÿè®¡:")
        print(f"  å›½å†…åŸå¸‚ ({len(domestic_origins)}): {', '.join(domestic_origins)}")
        print(f"  å›½é™…åŸå¸‚ ({len(international_origins)}): {', '.join(international_origins)}")
    
    if 'destination' in df.columns:
        destinations = get_sorted_cities(df, 'destination')
        domestic_destinations = [city for city in destinations if categorize_city(city) == 'å›½å†…']
        international_destinations = [city for city in destinations if categorize_city(city) == 'å›½é™…']
        
        print(f"\nç›®çš„åœ°ç»Ÿè®¡:")
        print(f"  å›½å†…åŸå¸‚ ({len(domestic_destinations)}): {', '.join(domestic_destinations)}")
        print(f"  å›½é™…åŸå¸‚ ({len(international_destinations)}): {', '.join(international_destinations)}")