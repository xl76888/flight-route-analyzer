<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dåœ°å›¾è°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map3d {
            width: 100%;
            height: 500px;
            border: 1px solid #ccc;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ” 3Dåœ°å›¾è°ƒè¯•æµ‹è¯•</h1>
    <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•Google Maps 3D APIæ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ</p>
    
    <div id="status-container">
        <div class="status info">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>
    
    <h2>ğŸ—ºï¸ 3Dåœ°å›¾æµ‹è¯•</h2>
    <gmp-map-3d id="map3d"
        center="39.9042,116.4074"
        zoom="5"
        map-id="45c4f1595b0cd27f9feda952"
        mode="HYBRID"
        tilt="45"
        heading="0">
    </gmp-map-3d>
    
    <div id="debug-info">
        <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
        <div id="debug-logs"></div>
    </div>
    
    <script>
        const API_KEY = 'AIzaSyBoAqo1lCI2FAQIY7A0jTlXI79mC2SO4Kw';
        const MAP_ID = '45c4f1595b0cd27f9feda952';
        
        function addStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            container.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function addDebugLog(message) {
            const logs = document.getElementById('debug-logs');
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logs.appendChild(div);
        }
        
        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        function checkBrowserSupport() {
            addDebugLog('æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...');
            
            // æ£€æŸ¥WebGLæ”¯æŒ
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) {
                addStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒWebGLï¼Œ3Dåœ°å›¾æ— æ³•å·¥ä½œ', 'error');
                return false;
            }
            addStatus('âœ… WebGLæ”¯æŒæ­£å¸¸', 'success');
            
            // æ£€æŸ¥è‡ªå®šä¹‰å…ƒç´ æ”¯æŒ
            if (!window.customElements) {
                addStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒè‡ªå®šä¹‰å…ƒç´ ', 'error');
                return false;
            }
            addStatus('âœ… è‡ªå®šä¹‰å…ƒç´ æ”¯æŒæ­£å¸¸', 'success');
            
            return true;
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testAPIConnection() {
            addDebugLog('æµ‹è¯•APIè¿æ¥...');
            
            try {
                const response = await fetch(`https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=maps3d&v=beta`);
                if (response.ok) {
                    addStatus('âœ… APIè¿æ¥æ­£å¸¸', 'success');
                    return true;
                } else {
                    addStatus(`âŒ APIè¿æ¥å¤±è´¥: HTTP ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                addStatus(`âŒ APIè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                return false;
            }
        }
        
        // åŠ è½½Google Maps API
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                addDebugLog('åŠ è½½Google Maps API...');
                
                if (typeof google !== 'undefined' && google.maps) {
                    addStatus('âœ… Google Maps APIå·²åŠ è½½', 'success');
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=maps3d&v=beta`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    addStatus('âœ… Google Maps APIåŠ è½½æˆåŠŸ', 'success');
                    addDebugLog('APIåŠ è½½å®Œæˆ');
                    resolve();
                };
                
                script.onerror = () => {
                    addStatus('âŒ Google Maps APIåŠ è½½å¤±è´¥', 'error');
                    reject(new Error('APIåŠ è½½å¤±è´¥'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // åˆå§‹åŒ–3Dåœ°å›¾
        function init3DMap() {
            addDebugLog('åˆå§‹åŒ–3Dåœ°å›¾...');
            
            const map3d = document.getElementById('map3d');
            if (!map3d) {
                addStatus('âŒ æ‰¾ä¸åˆ°3Dåœ°å›¾å…ƒç´ ', 'error');
                return;
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            map3d.addEventListener('gmp-load', () => {
                addStatus('âœ… 3Dåœ°å›¾åŠ è½½æˆåŠŸï¼', 'success');
                addDebugLog('åœ°å›¾åŠ è½½å®Œæˆ');
            });
            
            map3d.addEventListener('gmp-error', (event) => {
                addStatus(`âŒ 3Dåœ°å›¾åŠ è½½é”™è¯¯: ${event.detail}`, 'error');
                addDebugLog(`åœ°å›¾é”™è¯¯: ${event.detail}`);
            });
            
            addStatus('â³ ç­‰å¾…3Dåœ°å›¾åŠ è½½...', 'info');
        }
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            addDebugLog('å¼€å§‹åˆå§‹åŒ–...');
            
            try {
                // 1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!checkBrowserSupport()) {
                    return;
                }
                
                // 2. æµ‹è¯•APIè¿æ¥
                await testAPIConnection();
                
                // 3. åŠ è½½Google Maps API
                await loadGoogleMapsAPI();
                
                // 4. åˆå§‹åŒ–3Dåœ°å›¾
                init3DMap();
                
                addStatus('ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼', 'success');
                
            } catch (error) {
                addStatus(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                addDebugLog(`åˆå§‹åŒ–é”™è¯¯: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addDebugLog('é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(initialize, 500);
        });
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            addStatus(`âŒ é¡µé¢é”™è¯¯: ${event.error?.message || event.message}`, 'error');
            addDebugLog(`é¡µé¢é”™è¯¯: ${event.error?.message || event.message}`);
        });
        
        addDebugLog('è°ƒè¯•è„šæœ¬å·²åŠ è½½');
    </script>
</body>
</html>