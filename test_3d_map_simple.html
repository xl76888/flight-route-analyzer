<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D地图测试</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #map3d { width: 100%; height: 500px; border: 1px solid #ccc; }
        #status { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>3D地图加载测试</h1>
    <div id="status">正在初始化...</div>
    
    <gmp-map-3d id="map3d"
                  center="39.9042,116.4074"
                  zoom="5"
                  map-id="45c4f1595b0cd27f9feda952"
                  mode="HYBRID"
                  style="width: 100%; height: 500px;">
    </gmp-map-3d>
    
    <script>
        const API_KEY = 'AIzaSyBjsINSWCu7yZrUaWmgHJUXnlBHKOTzrQs';
        const MAP_ID = '45c4f1595b0cd27f9feda952';
        
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'error' : 'success';
        }
        
        async function loadGoogleMapsAPI() {
            try {
                updateStatus('正在加载Google Maps API...');
                
                if (typeof google !== 'undefined' && google.maps) {
                    updateStatus('Google Maps API已存在');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=maps3d&v=beta`;
                script.async = true;
                script.defer = true;
                
                await new Promise((resolve, reject) => {
                    script.onload = () => {
                        updateStatus('Google Maps API加载成功');
                        resolve();
                    };
                    
                    script.onerror = () => {
                        updateStatus('Google Maps API加载失败', true);
                        reject(new Error('API加载失败'));
                    };
                    
                    document.head.appendChild(script);
                });
                
            } catch (error) {
                updateStatus(`API加载错误: ${error.message}`, true);
                throw error;
            }
        }
        
        async function initMap() {
            try {
                await loadGoogleMapsAPI();
                
                const map = document.getElementById('map3d');
                if (!map) {
                    updateStatus('找不到地图容器', true);
                    return;
                }
                
                map.addEventListener('gmp-load', () => {
                    updateStatus('3D地图加载成功！地图已准备就绪。');
                });
                
                map.addEventListener('gmp-error', (event) => {
                    updateStatus(`3D地图加载错误: ${event.detail}`, true);
                });
                
                updateStatus('3D地图初始化完成，等待加载...');
                
            } catch (error) {
                updateStatus(`初始化失败: ${error.message}`, true);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>